<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Deliver Feedback</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static',filename='styles/main.css') }}"
      type="text/css"
    />

    <!-- Font Awesome Icon Library -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />
    <style>
      .checked {
        color: orange;
      }
    </style>
  </head>

  <script>
    function displayStars(numStars) {
      var stars = document.createElement("div");

      for (var x = 0; x < 5; x++) {
        var star = document.createElement("span");

        if (x < numStars) {
          star.className = "fa fa-star checked";
        } else {
          star.className = "fa fa-star";
        }

        stars.appendChild(star);
      }

      return stars;
    }

    function createTable(tableData) {
      var table = document.getElementById("thisTable");
      var tablediv = document.getElementById("tablediv");
      var form = document.getElementById("feedbackform");
      var tableBody = document.createElement("tbody");

      tableData.forEach(function (rowData) {
        var row = document.createElement("tr");
        for (var i = 0; i < 4; i++) {
          var cellData = rowData[i];
          if (i == 1) {
            switch (cellData) {
              case "Star Rating":
                var cell = document.createElement("td");
                var stars = displayStars(rowData[2]);
                cell.appendChild(stars);

                break;
              case "Text":
                var cell = document.createElement("td");
                cell.appendChild(document.createTextNode(rowData[2]));
            }
          } else if (i==3){
            var cell = document.createElement("td");
            cell.appendChild(document.createTextNode(cellData));
          } else if (i==0){
            var cell = document.createElement("td");
            cell.appendChild(document.createTextNode(cellData));
          } 
          row.appendChild(cell);
        }
        tableBody.appendChild(row);
      });

      table.appendChild(tableBody);

      form.insertBefore(table, form.firstChild);

      tablediv.appendChild(form);
    }
  </script>

  <!-- https://stackoverflow.com/questions/15164655/generate-html-table-from-2d-javascript-array -->
  <!-- https://stackoverflow.com/questions/61472018/how-do-i-convert-pythonflask-list-of-objects-to-js-list-of-objects -->
  <body>
    <div class="box header"><h2>Feedback System</h2></div>
    <br />

    <div class="screenbox" id="tablediv" width="600px">
      <h1>{{g.room_code}}</h1>

      <br />
      <table id="thisTable" name="thisTable" width="350px">
        <caption>
          Feedback Form
        </caption>
        <tr>
          <th>Question</th>
          <th>Feedback</th>
          <th>Sentiment score</th>
        </tr>
      </table>

      <script>
        var entries = JSON.parse('{{ g.jdump|safe }}');
        console.log(entries);
        createTable(entries);
        //console.log(entries);
      </script>
    </div>

    <script
      src="https://unpkg.com/react@17/umd/react.development.js"
      crossorigin
    ></script>
    <script
      src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"
      crossorigin
    ></script>


    <h1>Rooname Feedback</h1>


       <!--User picks what feedback they want displayed -->
      Feedback Type
      <form action="/action_page.php">
        <input type="checkbox" id="checkbox1" name="checkbox1" value="overallFeedback">
        <label for="checkbox1"> Overall Feedback</label><br>
        <input type="checkbox" id="checkbox2" name="checkbox2" value="timePeriod">
        <label for="checkbox2"> Feedback over last specified time period</label><br>
      </form>


       <!-- User can select the time period from which they can see feedback -->
      <div style="border: 1px solid #000000;">

      Show feedback for the last
      <form action="/action.php">
        <label for="hours">hours:</label><br>
        <input type="text" id="hours" name="hours" value="hours"><br>
        <label for="minutes">minutes:</label><br>
        <input type="text" id="minutes" name="minutes" value="minutes"><br><br>
        <input type="submit" value="Submit">
      </form>

      </div>


       <!-- Pie charts displayed here -->
      <div style="width: 100%; display: table;">
          <div style="display: table-row">
              <div style="width: 600px; display: table-cell;", id="averageMood"> Left </div>
              <div style="display: table-cell;", id="averageRating"> Right </div>
          </div>
      </div>


      <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>


      <script type="text/javascript">
      // Load google charts
      google.charts.load('current', {'packages':['corechart']});
      google.charts.setOnLoadCallback(drawChart);


      // Draw the chart and set the chart values from the database
      function drawChart() {

        var entries = JSON.parse('{{ g.jdump|safe }}');
        var one = 0;
        var two = 0;
        var three = 0;
        var four = 0;
        var five = 0;

        var number = 0;
        var totalStars = 0;

        for(var index = 0; index < entries.length; index++) {
          if (entries[index][1] == 'Star Rating'){

            number = number + 1;
            totalStars = totalStars + parseInt(entries[index][2]);


            if (entries[index][2] == '1'){
              one = one + 1;
            }

            if (entries[index][2] == '2'){
              two = two + 1;
            }

            if (entries[index][2] == '3'){
              three = three + 1;
            }

            if (entries[index][2] == '4'){
              four = four + 1;
            }

            if (entries[index][2] == '5'){
              five = five + 1;
            }
            
          }
        }

        var averageStars = totalStars/number;

        var averageStars = averageStars.toString();




        
        var data = google.visualization.arrayToDataTable([
        ['Rating', 'Frequency'],
        ['1 Star', one],
        ['2 Star', two],
        ['3 Star', three],
        ['4 Star', four],
        ['5 Star', five]
      ]);

        // Title and the width and height of the chart average rating taken from the database
        averageStars = averageStars.substring(0,6);
        var options = {'title':'Average Rating ' + averageStars, 'width':550, 'height':400};

        // Display the chart inside the <div> element with id="piechart"
        var chart = new google.visualization.PieChart(document.getElementById('averageRating'));
        chart.draw(data, options);
      }
      </script>

      <script type="text/javascript">
      // Load google charts
      google.charts.load('current', {'packages':['corechart']});
      google.charts.setOnLoadCallback(drawChart2);


      // Draw the chart and set the chart values
      function drawChart2() {

        var entries = JSON.parse('{{ g.jdump|safe }}');

        var positive = 0;
        var negative = 0;
        var neutral = 0;

        var number = 0;
        var totalScore = 0;

        for(var index = 0; index < entries.length; index++) {
          if (entries[index][1] == 'Text'){

            number = number + 1;
            totalScore = totalScore + entries[index][3];

            if (entries[index][3] <= -0.1){
              negative = negative + 1;
            }
            if (-0.1 < entries[index][3] && entries[index][3] < 0.1){
              neutral = neutral + 1;
            }
            if (entries[index][3] >= 0.1){
              positive = positive + 1;
            }
          }
        }

        var averageScore = totalScore/number;

        var averageScore = averageScore.toString();

        var data = google.visualization.arrayToDataTable([
        ['Mood', 'Frequency'],
        ['Positive', positive],
        ['Neutral', neutral],
        ['Negative', negative]
      ]);

        // title and the width and height of the chart average mood displayed from database
        averageScore = averageScore.substring(0,6);
        var options = {'title':'Average Mood ' + averageScore, 'width':550, 'height':400};



        // Display the chart inside the <div> element with id="piechart"
        var chart = new google.visualization.PieChart(document.getElementById('averageMood'));
        chart.draw(data, options);
      }
      </script>
  </body>
</html>